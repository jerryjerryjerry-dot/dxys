<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>APIæ¥å£æµ‹è¯•å·¥å…·</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f7fa;
      color: #333;
    }

    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #1890ff;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.2em;
    }

    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
    }

    .section-title {
      font-size: 1.3em;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #1890ff;
    }

    .mode-switch {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .mode-btn {
      padding: 10px 20px;
      border: 2px solid #1890ff;
      background: white;
      color: #1890ff;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mode-btn.active {
      background: #1890ff;
      color: white;
    }

    .mode-btn:hover {
      background: #40a9ff;
      color: white;
      border-color: #40a9ff;
    }

    .config-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .config-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    label {
      font-weight: 500;
      color: #555;
    }

    input,
    select,
    textarea {
      padding: 8px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #1890ff;
      outline: none;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }

    .btn {
      background: #1890ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
      margin: 5px;
    }

    .btn:hover {
      background: #40a9ff;
    }

    .btn-success {
      background: #52c41a;
    }

    .btn-success:hover {
      background: #73d13d;
    }

    .btn-danger {
      background: #ff4d4f;
    }

    .btn-danger:hover {
      background: #ff7875;
    }

    .result {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }

    .result.success {
      background: #f6ffed;
      border-color: #b7eb8f;
      color: #389e0d;
    }

    .result.error {
      background: #fff2f0;
      border-color: #ffccc7;
      color: #cf1322;
    }

    .api-endpoints {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .endpoint-card {
      background: #fafafa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e8e8e8;
    }

    .endpoint-method {
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 12px;
      margin-right: 10px;
    }

    .method-get {
      background: #52c41a;
      color: white;
    }

    .method-post {
      background: #1890ff;
      color: white;
    }

    .method-put {
      background: #faad14;
      color: white;
    }

    .method-delete {
      background: #ff4d4f;
      color: white;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-local {
      background: #52c41a;
    }

    .status-api {
      background: #1890ff;
    }

    .status-error {
      background: #ff4d4f;
    }

    .test-results {
      margin-top: 20px;
    }

    .test-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .test-item:last-child {
      border-bottom: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ”Œ APIæ¥å£æµ‹è¯•å·¥å…·</h1>

    <!-- æ¨¡å¼åˆ‡æ¢ -->
    <div class="section">
      <div class="section-title">ğŸ”„ æ•°æ®æºæ¨¡å¼</div>
      <div class="mode-switch">
        <button class="mode-btn active" id="local-mode-btn" onclick="switchMode('indexeddb')">
          <span class="status-indicator status-local"></span>
          æœ¬åœ°æ•°æ®åº“ (IndexedDB)
        </button>
        <button class="mode-btn" id="api-mode-btn" onclick="switchMode('api')">
          <span class="status-indicator status-api"></span>
          APIæ¥å£
        </button>
      </div>
      <div id="mode-status" class="result">
        å½“å‰æ¨¡å¼: <strong id="current-mode">indexeddb</strong>
      </div>
    </div>

    <!-- APIé…ç½® -->
    <div class="section">
      <div class="section-title">âš™ï¸ APIé…ç½®</div>
      <div class="config-section">
        <div class="config-item">
          <label for="api-env">ç¯å¢ƒ:</label>
          <select id="api-env" onchange="updateApiConfig()">
            <option value="development">å¼€å‘ç¯å¢ƒ</option>
            <option value="staging">æµ‹è¯•ç¯å¢ƒ</option>
            <option value="production">ç”Ÿäº§ç¯å¢ƒ</option>
          </select>
        </div>
        <div class="config-item">
          <label for="api-url">APIåœ°å€:</label>
          <input type="text" id="api-url" value="http://localhost:3000" onchange="updateApiConfig()">
        </div>
      </div>
      <div class="config-item">
        <label for="auth-token">è®¤è¯ä»¤ç‰Œ (å¯é€‰):</label>
        <input type="text" id="auth-token" placeholder="Bearer token" onchange="updateAuthToken()">
      </div>
      <button class="btn" onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
      <div id="connection-result"></div>
    </div>

    <!-- APIç«¯ç‚¹åˆ—è¡¨ -->
    <div class="section">
      <div class="section-title">ğŸ“¡ APIç«¯ç‚¹</div>
      <div class="api-endpoints">
        <div class="endpoint-card">
          <div>
            <span class="endpoint-method method-get">GET</span>
            <code>/api/coloring-strategies</code>
          </div>
          <p>è·å–æ‰€æœ‰æµé‡æŸ“è‰²ç­–ç•¥</p>
          <button class="btn btn-success" onclick="testEndpoint('getAll')">æµ‹è¯•</button>
        </div>
        <div class="endpoint-card">
          <div>
            <span class="endpoint-method method-post">POST</span>
            <code>/api/coloring-strategies</code>
          </div>
          <p>åˆ›å»ºæ–°çš„æµé‡æŸ“è‰²ç­–ç•¥</p>
          <button class="btn btn-success" onclick="testEndpoint('create')">æµ‹è¯•</button>
        </div>
        <div class="endpoint-card">
          <div>
            <span class="endpoint-method method-put">PUT</span>
            <code>/api/coloring-strategies/:id</code>
          </div>
          <p>æ›´æ–°æŒ‡å®šçš„æµé‡æŸ“è‰²ç­–ç•¥</p>
          <button class="btn btn-success" onclick="testEndpoint('update')">æµ‹è¯•</button>
        </div>
        <div class="endpoint-card">
          <div>
            <span class="endpoint-method method-delete">DELETE</span>
            <code>/api/coloring-strategies/:id</code>
          </div>
          <p>åˆ é™¤æŒ‡å®šçš„æµé‡æŸ“è‰²ç­–ç•¥</p>
          <button class="btn btn-danger" onclick="testEndpoint('delete')">æµ‹è¯•</button>
        </div>
      </div>
    </div>

    <!-- åŠŸèƒ½æµ‹è¯• -->
    <div class="section">
      <div class="section-title">ğŸ§ª åŠŸèƒ½æµ‹è¯•</div>
      <div style="margin-bottom: 15px;">
        <button class="btn" onclick="runFullTest()">å®Œæ•´æµ‹è¯•</button>
        <button class="btn btn-success" onclick="testCRUD()">CRUDæµ‹è¯•</button>
        <button class="btn" onclick="testPerformance()">æ€§èƒ½æµ‹è¯•</button>
        <button class="btn btn-danger" onclick="clearResults()">æ¸…ç©ºç»“æœ</button>
      </div>
      <div class="test-results" id="test-results"></div>
    </div>

    <!-- å®æ—¶æ—¥å¿— -->
    <div class="section">
      <div class="section-title">ğŸ“ å®æ—¶æ—¥å¿—</div>
      <div class="result" id="log-output" style="height: 200px;">
        ç­‰å¾…æ“ä½œ...
      </div>
      <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
  </div>

  <!-- å¼•å…¥ä¾èµ– -->
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
  <script src="AppDataManagerV2.js"></script>
  <script src="api-config.js"></script>

  <script>
    let currentMode = 'indexeddb';
    let testResults = [];

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function () {
      await initializeApp();
      updateModeDisplay();
      log('âœ… APIæµ‹è¯•å·¥å…·å·²åˆå§‹åŒ–');
    });

    async function initializeApp() {
      try {
        if (!AppDataManagerV2.initialized) {
          await AppDataManagerV2.init();
        }
      } catch (error) {
        log(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
      }
    }

    // åˆ‡æ¢æ¨¡å¼
    function switchMode(mode) {
      currentMode = mode;

      if (typeof AppDataManagerV2 !== 'undefined') {
        AppDataManagerV2.coloringStrategies.dataAdapter.setMode(mode);
      }

      updateModeDisplay();
      log(`ğŸ”„ å·²åˆ‡æ¢åˆ° ${mode === 'indexeddb' ? 'æœ¬åœ°æ•°æ®åº“' : 'APIæ¥å£'} æ¨¡å¼`);
    }

    function updateModeDisplay() {
      document.getElementById('current-mode').textContent = currentMode;

      const localBtn = document.getElementById('local-mode-btn');
      const apiBtn = document.getElementById('api-mode-btn');

      if (currentMode === 'indexeddb') {
        localBtn.classList.add('active');
        apiBtn.classList.remove('active');
      } else {
        localBtn.classList.remove('active');
        apiBtn.classList.add('active');
      }
    }

    // æ›´æ–°APIé…ç½®
    function updateApiConfig() {
      const env = document.getElementById('api-env').value;
      const url = document.getElementById('api-url').value;

      if (typeof ApiConfig !== 'undefined') {
        ApiConfig.currentEnv = env;
        ApiConfig.environments[env].baseURL = url;
      }

      log(`âš™ï¸ APIé…ç½®å·²æ›´æ–°: ${env} - ${url}`);
    }

    // æ›´æ–°è®¤è¯ä»¤ç‰Œ
    function updateAuthToken() {
      const token = document.getElementById('auth-token').value;

      if (typeof ApiConfig !== 'undefined') {
        if (token) {
          ApiConfig.setAuthToken(token);
          log('ğŸ” è®¤è¯ä»¤ç‰Œå·²è®¾ç½®');
        } else {
          ApiConfig.clearAuthToken();
          log('ğŸ” è®¤è¯ä»¤ç‰Œå·²æ¸…é™¤');
        }
      }
    }

    // æµ‹è¯•è¿æ¥
    async function testConnection() {
      const resultDiv = document.getElementById('connection-result');
      resultDiv.innerHTML = 'ğŸ”„ æµ‹è¯•ä¸­...';

      try {
        if (currentMode === 'api') {
          const response = await ApiConfig.get('/api/coloring-strategies');
          resultDiv.innerHTML = '<div class="result success">âœ… APIè¿æ¥æˆåŠŸ</div>';
          log('âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸ');
        } else {
          const count = await AppDataManagerV2.db.coloringStrategies.count();
          resultDiv.innerHTML = `<div class="result success">âœ… æœ¬åœ°æ•°æ®åº“è¿æ¥æˆåŠŸ (${count} æ¡è®°å½•)</div>`;
          log(`âœ… æœ¬åœ°æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œæ‰¾åˆ° ${count} æ¡è®°å½•`);
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">âŒ è¿æ¥å¤±è´¥: ${error.message}</div>`;
        log(`âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    // æµ‹è¯•ç«¯ç‚¹
    async function testEndpoint(operation) {
      log(`ğŸ§ª æµ‹è¯•ç«¯ç‚¹: ${operation}`);

      try {
        let result;

        switch (operation) {
          case 'getAll':
            result = await AppDataManagerV2.coloringStrategies.getAll();
            log(`âœ… è·å–æ‰€æœ‰ç­–ç•¥æˆåŠŸ: ${result.length} æ¡è®°å½•`);
            break;

          case 'create':
            const testData = {
              name: `æµ‹è¯•ç­–ç•¥_${Date.now()}`,
              scope: 'æµ‹è¯•éƒ¨é—¨',
              techniques: ['åº”ç”¨æŸ“è‰²'],
              note: 'è¿™æ˜¯ä¸€ä¸ªAPIæµ‹è¯•ç­–ç•¥',
              status: true,
              effectObject: 'æµ‹è¯•ç”¨æˆ·',
              coloringConfig: {
                appColoring: {
                  enabled: true,
                  address: true,
                  protocol: false,
                  ip: true
                },
                dataFlowColoring: false,
                dataTrackingColoring: false
              }
            };
            result = await AppDataManagerV2.coloringStrategies.add(testData);
            log(`âœ… åˆ›å»ºç­–ç•¥æˆåŠŸ: ID ${result.id || result}`);
            break;

          case 'update':
            const strategies = await AppDataManagerV2.coloringStrategies.getAll();
            if (strategies.length > 0) {
              const updateData = { note: `æ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}` };
              await AppDataManagerV2.coloringStrategies.update(strategies[0].id, updateData);
              log(`âœ… æ›´æ–°ç­–ç•¥æˆåŠŸ: ID ${strategies[0].id}`);
            } else {
              log('âš ï¸ æ²¡æœ‰å¯æ›´æ–°çš„ç­–ç•¥');
            }
            break;

          case 'delete':
            const allStrategies = await AppDataManagerV2.coloringStrategies.getAll();
            const testStrategies = allStrategies.filter(s => s.name.includes('æµ‹è¯•ç­–ç•¥'));
            if (testStrategies.length > 0) {
              await AppDataManagerV2.coloringStrategies.delete(testStrategies[0].id);
              log(`âœ… åˆ é™¤ç­–ç•¥æˆåŠŸ: ID ${testStrategies[0].id}`);
            } else {
              log('âš ï¸ æ²¡æœ‰å¯åˆ é™¤çš„æµ‹è¯•ç­–ç•¥');
            }
            break;
        }

        addTestResult(operation, true, result);
      } catch (error) {
        log(`âŒ æµ‹è¯•ç«¯ç‚¹å¤±è´¥ [${operation}]: ${error.message}`);
        addTestResult(operation, false, error);
      }
    }

    // å®Œæ•´æµ‹è¯•
    async function runFullTest() {
      log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•...');

      const tests = ['getAll', 'create', 'update', 'delete'];

      for (const test of tests) {
        await testEndpoint(test);
        await new Promise(resolve => setTimeout(resolve, 500)); // å»¶è¿Ÿ500ms
      }

      log('âœ… å®Œæ•´æµ‹è¯•å®Œæˆ');
    }

    // CRUDæµ‹è¯•
    async function testCRUD() {
      log('ğŸ”„ å¼€å§‹CRUDæµ‹è¯•...');

      try {
        // Create
        const createData = {
          name: `CRUDæµ‹è¯•_${Date.now()}`,
          scope: 'CRUDæµ‹è¯•',
          techniques: ['æµ‹è¯•æŸ“è‰²'],
          note: 'CRUDæµ‹è¯•ç­–ç•¥',
          status: true,
          effectObject: 'CRUDæµ‹è¯•',
          coloringConfig: {
            appColoring: { enabled: true, address: true, protocol: false, ip: true },
            dataFlowColoring: true,
            dataTrackingColoring: false
          }
        };
        const created = await AppDataManagerV2.coloringStrategies.add(createData);
        log(`âœ… C-åˆ›å»º: ID ${created.id || created}`);

        // Read
        const strategies = await AppDataManagerV2.coloringStrategies.getAll();
        const createdStrategy = strategies.find(s => s.name === createData.name);
        log(`âœ… R-è¯»å–: æ‰¾åˆ°ç­–ç•¥ ${createdStrategy ? createdStrategy.id : 'æœªæ‰¾åˆ°'}`);

        if (createdStrategy) {
          // Update
          await AppDataManagerV2.coloringStrategies.update(createdStrategy.id, {
            note: 'CRUDæµ‹è¯•ç­–ç•¥-å·²æ›´æ–°'
          });
          log(`âœ… U-æ›´æ–°: ID ${createdStrategy.id}`);

          // Delete
          await AppDataManagerV2.coloringStrategies.delete(createdStrategy.id);
          log(`âœ… D-åˆ é™¤: ID ${createdStrategy.id}`);
        }

        log('âœ… CRUDæµ‹è¯•å®Œæˆ');
      } catch (error) {
        log(`âŒ CRUDæµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    // æ€§èƒ½æµ‹è¯•
    async function testPerformance() {
      log('âš¡ å¼€å§‹æ€§èƒ½æµ‹è¯•...');

      const startTime = performance.now();

      try {
        const strategies = await AppDataManagerV2.coloringStrategies.getAll();
        const endTime = performance.now();
        const duration = Math.round(endTime - startTime);

        log(`âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ: è·å– ${strategies.length} æ¡è®°å½•è€—æ—¶ ${duration}ms`);
      } catch (error) {
        log(`âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    // æ·»åŠ æµ‹è¯•ç»“æœ
    function addTestResult(test, success, result) {
      testResults.push({
        test,
        success,
        result,
        timestamp: new Date().toLocaleString()
      });

      updateTestResultsDisplay();
    }

    // æ›´æ–°æµ‹è¯•ç»“æœæ˜¾ç¤º
    function updateTestResultsDisplay() {
      const container = document.getElementById('test-results');

      if (testResults.length === 0) {
        container.innerHTML = '<p>æš‚æ— æµ‹è¯•ç»“æœ</p>';
        return;
      }

      let html = '';
      testResults.forEach(result => {
        const statusIcon = result.success ? 'âœ…' : 'âŒ';
        const statusClass = result.success ? 'success' : 'error';

        html += `
                    <div class="test-item">
                        <span>${statusIcon} ${result.test}</span>
                        <span class="${statusClass}">${result.timestamp}</span>
                    </div>
                `;
      });

      container.innerHTML = html;
    }

    // æ¸…ç©ºç»“æœ
    function clearResults() {
      testResults = [];
      updateTestResultsDisplay();
      log('ğŸ§¹ æµ‹è¯•ç»“æœå·²æ¸…ç©º');
    }

    // æ—¥å¿—åŠŸèƒ½
    function log(message) {
      const logOutput = document.getElementById('log-output');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}\n`;

      logOutput.textContent += logEntry;
      logOutput.scrollTop = logOutput.scrollHeight;

      console.log(message);
    }

    function clearLog() {
      document.getElementById('log-output').textContent = 'ç­‰å¾…æ“ä½œ...\n';
    }
  </script>
</body>

</html>