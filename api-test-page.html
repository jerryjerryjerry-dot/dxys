<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API接口测试工具</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f7fa;
      color: #333;
    }

    .container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #1890ff;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.2em;
    }

    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #e8e8e8;
      border-radius: 8px;
    }

    .section-title {
      font-size: 1.3em;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid #1890ff;
    }

    .mode-switch {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .mode-btn {
      padding: 10px 20px;
      border: 2px solid #1890ff;
      background: white;
      color: #1890ff;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mode-btn.active {
      background: #1890ff;
      color: white;
    }

    .mode-btn:hover {
      background: #40a9ff;
      color: white;
      border-color: #40a9ff;
    }

    .config-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .config-item {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    label {
      font-weight: 500;
      color: #555;
    }

    input,
    select,
    textarea {
      padding: 8px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      font-size: 14px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #1890ff;
      outline: none;
      box-shadow: 0 0 0 2px rgba(24, 144, 255, 0.2);
    }

    .btn {
      background: #1890ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s;
      margin: 5px;
    }

    .btn:hover {
      background: #40a9ff;
    }

    .btn-success {
      background: #52c41a;
    }

    .btn-success:hover {
      background: #73d13d;
    }

    .btn-danger {
      background: #ff4d4f;
    }

    .btn-danger:hover {
      background: #ff7875;
    }

    .result {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }

    .result.success {
      background: #f6ffed;
      border-color: #b7eb8f;
      color: #389e0d;
    }

    .result.error {
      background: #fff2f0;
      border-color: #ffccc7;
      color: #cf1322;
    }

    .api-endpoints {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .endpoint-card {
      background: #fafafa;
      padding: 15px;
      border-radius: 6px;
      border: 1px solid #e8e8e8;
    }

    .endpoint-method {
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 12px;
      margin-right: 10px;
    }

    .method-get {
      background: #52c41a;
      color: white;
    }

    .method-post {
      background: #1890ff;
      color: white;
    }

    .method-put {
      background: #faad14;
      color: white;
    }

    .method-delete {
      background: #ff4d4f;
      color: white;
    }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-local {
      background: #52c41a;
    }

    .status-api {
      background: #1890ff;
    }

    .status-error {
      background: #ff4d4f;
    }

    .test-results {
      margin-top: 20px;
    }

    .test-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .test-item:last-child {
      border-bottom: none;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>🔌 API接口测试工具</h1>

    <!-- 模式切换 -->
    <div class="section">
      <div class="section-title">🔄 数据源模式</div>
      <div class="mode-switch">
        <button class="mode-btn active" id="local-mode-btn" onclick="switchMode('indexeddb')">
          <span class="status-indicator status-local"></span>
          本地数据库 (IndexedDB)
        </button>
        <button class="mode-btn" id="api-mode-btn" onclick="switchMode('api')">
          <span class="status-indicator status-api"></span>
          API接口
        </button>
      </div>
      <div id="mode-status" class="result">
        当前模式: <strong id="current-mode">indexeddb</strong>
      </div>
    </div>

    <!-- API配置 -->
    <div class="section">
      <div class="section-title">⚙️ API配置</div>
      <div class="config-section">
        <div class="config-item">
          <label for="api-env">环境:</label>
          <select id="api-env" onchange="updateApiConfig()">
            <option value="development">开发环境</option>
            <option value="staging">测试环境</option>
            <option value="production">生产环境</option>
          </select>
        </div>
        <div class="config-item">
          <label for="api-url">API地址:</label>
          <input type="text" id="api-url" value="http://localhost:3000" onchange="updateApiConfig()">
        </div>
      </div>
      <div class="config-item">
        <label for="auth-token">认证令牌 (可选):</label>
        <input type="text" id="auth-token" placeholder="Bearer token" onchange="updateAuthToken()">
      </div>
      <button class="btn" onclick="testConnection()">测试连接</button>
      <div id="connection-result"></div>
    </div>

    <!-- API端点列表 -->
    <div class="section">
      <div class="section-title">📡 API端点</div>
      <div class="api-endpoints">
        <div class="endpoint-card">
          <div>
            <span class="endpoint-method method-get">GET</span>
            <code>/api/coloring-strategies</code>
          </div>
          <p>获取所有流量染色策略</p>
          <button class="btn btn-success" onclick="testEndpoint('getAll')">测试</button>
        </div>
        <div class="endpoint-card">
          <div>
            <span class="endpoint-method method-post">POST</span>
            <code>/api/coloring-strategies</code>
          </div>
          <p>创建新的流量染色策略</p>
          <button class="btn btn-success" onclick="testEndpoint('create')">测试</button>
        </div>
        <div class="endpoint-card">
          <div>
            <span class="endpoint-method method-put">PUT</span>
            <code>/api/coloring-strategies/:id</code>
          </div>
          <p>更新指定的流量染色策略</p>
          <button class="btn btn-success" onclick="testEndpoint('update')">测试</button>
        </div>
        <div class="endpoint-card">
          <div>
            <span class="endpoint-method method-delete">DELETE</span>
            <code>/api/coloring-strategies/:id</code>
          </div>
          <p>删除指定的流量染色策略</p>
          <button class="btn btn-danger" onclick="testEndpoint('delete')">测试</button>
        </div>
      </div>
    </div>

    <!-- 功能测试 -->
    <div class="section">
      <div class="section-title">🧪 功能测试</div>
      <div style="margin-bottom: 15px;">
        <button class="btn" onclick="runFullTest()">完整测试</button>
        <button class="btn btn-success" onclick="testCRUD()">CRUD测试</button>
        <button class="btn" onclick="testPerformance()">性能测试</button>
        <button class="btn btn-danger" onclick="clearResults()">清空结果</button>
      </div>
      <div class="test-results" id="test-results"></div>
    </div>

    <!-- 实时日志 -->
    <div class="section">
      <div class="section-title">📝 实时日志</div>
      <div class="result" id="log-output" style="height: 200px;">
        等待操作...
      </div>
      <button class="btn" onclick="clearLog()">清空日志</button>
    </div>
  </div>

  <!-- 引入依赖 -->
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
  <script src="AppDataManagerV2.js"></script>
  <script src="api-config.js"></script>

  <script>
    let currentMode = 'indexeddb';
    let testResults = [];

    // 初始化
    document.addEventListener('DOMContentLoaded', async function () {
      await initializeApp();
      updateModeDisplay();
      log('✅ API测试工具已初始化');
    });

    async function initializeApp() {
      try {
        if (!AppDataManagerV2.initialized) {
          await AppDataManagerV2.init();
        }
      } catch (error) {
        log(`❌ 初始化失败: ${error.message}`);
      }
    }

    // 切换模式
    function switchMode(mode) {
      currentMode = mode;

      if (typeof AppDataManagerV2 !== 'undefined') {
        AppDataManagerV2.coloringStrategies.dataAdapter.setMode(mode);
      }

      updateModeDisplay();
      log(`🔄 已切换到 ${mode === 'indexeddb' ? '本地数据库' : 'API接口'} 模式`);
    }

    function updateModeDisplay() {
      document.getElementById('current-mode').textContent = currentMode;

      const localBtn = document.getElementById('local-mode-btn');
      const apiBtn = document.getElementById('api-mode-btn');

      if (currentMode === 'indexeddb') {
        localBtn.classList.add('active');
        apiBtn.classList.remove('active');
      } else {
        localBtn.classList.remove('active');
        apiBtn.classList.add('active');
      }
    }

    // 更新API配置
    function updateApiConfig() {
      const env = document.getElementById('api-env').value;
      const url = document.getElementById('api-url').value;

      if (typeof ApiConfig !== 'undefined') {
        ApiConfig.currentEnv = env;
        ApiConfig.environments[env].baseURL = url;
      }

      log(`⚙️ API配置已更新: ${env} - ${url}`);
    }

    // 更新认证令牌
    function updateAuthToken() {
      const token = document.getElementById('auth-token').value;

      if (typeof ApiConfig !== 'undefined') {
        if (token) {
          ApiConfig.setAuthToken(token);
          log('🔐 认证令牌已设置');
        } else {
          ApiConfig.clearAuthToken();
          log('🔐 认证令牌已清除');
        }
      }
    }

    // 测试连接
    async function testConnection() {
      const resultDiv = document.getElementById('connection-result');
      resultDiv.innerHTML = '🔄 测试中...';

      try {
        if (currentMode === 'api') {
          const response = await ApiConfig.get('/api/coloring-strategies');
          resultDiv.innerHTML = '<div class="result success">✅ API连接成功</div>';
          log('✅ API连接测试成功');
        } else {
          const count = await AppDataManagerV2.db.coloringStrategies.count();
          resultDiv.innerHTML = `<div class="result success">✅ 本地数据库连接成功 (${count} 条记录)</div>`;
          log(`✅ 本地数据库连接成功，找到 ${count} 条记录`);
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="result error">❌ 连接失败: ${error.message}</div>`;
        log(`❌ 连接测试失败: ${error.message}`);
      }
    }

    // 测试端点
    async function testEndpoint(operation) {
      log(`🧪 测试端点: ${operation}`);

      try {
        let result;

        switch (operation) {
          case 'getAll':
            result = await AppDataManagerV2.coloringStrategies.getAll();
            log(`✅ 获取所有策略成功: ${result.length} 条记录`);
            break;

          case 'create':
            const testData = {
              name: `测试策略_${Date.now()}`,
              scope: '测试部门',
              techniques: ['应用染色'],
              note: '这是一个API测试策略',
              status: true,
              effectObject: '测试用户',
              coloringConfig: {
                appColoring: {
                  enabled: true,
                  address: true,
                  protocol: false,
                  ip: true
                },
                dataFlowColoring: false,
                dataTrackingColoring: false
              }
            };
            result = await AppDataManagerV2.coloringStrategies.add(testData);
            log(`✅ 创建策略成功: ID ${result.id || result}`);
            break;

          case 'update':
            const strategies = await AppDataManagerV2.coloringStrategies.getAll();
            if (strategies.length > 0) {
              const updateData = { note: `更新时间: ${new Date().toLocaleString()}` };
              await AppDataManagerV2.coloringStrategies.update(strategies[0].id, updateData);
              log(`✅ 更新策略成功: ID ${strategies[0].id}`);
            } else {
              log('⚠️ 没有可更新的策略');
            }
            break;

          case 'delete':
            const allStrategies = await AppDataManagerV2.coloringStrategies.getAll();
            const testStrategies = allStrategies.filter(s => s.name.includes('测试策略'));
            if (testStrategies.length > 0) {
              await AppDataManagerV2.coloringStrategies.delete(testStrategies[0].id);
              log(`✅ 删除策略成功: ID ${testStrategies[0].id}`);
            } else {
              log('⚠️ 没有可删除的测试策略');
            }
            break;
        }

        addTestResult(operation, true, result);
      } catch (error) {
        log(`❌ 测试端点失败 [${operation}]: ${error.message}`);
        addTestResult(operation, false, error);
      }
    }

    // 完整测试
    async function runFullTest() {
      log('🚀 开始完整测试...');

      const tests = ['getAll', 'create', 'update', 'delete'];

      for (const test of tests) {
        await testEndpoint(test);
        await new Promise(resolve => setTimeout(resolve, 500)); // 延迟500ms
      }

      log('✅ 完整测试完成');
    }

    // CRUD测试
    async function testCRUD() {
      log('🔄 开始CRUD测试...');

      try {
        // Create
        const createData = {
          name: `CRUD测试_${Date.now()}`,
          scope: 'CRUD测试',
          techniques: ['测试染色'],
          note: 'CRUD测试策略',
          status: true,
          effectObject: 'CRUD测试',
          coloringConfig: {
            appColoring: { enabled: true, address: true, protocol: false, ip: true },
            dataFlowColoring: true,
            dataTrackingColoring: false
          }
        };
        const created = await AppDataManagerV2.coloringStrategies.add(createData);
        log(`✅ C-创建: ID ${created.id || created}`);

        // Read
        const strategies = await AppDataManagerV2.coloringStrategies.getAll();
        const createdStrategy = strategies.find(s => s.name === createData.name);
        log(`✅ R-读取: 找到策略 ${createdStrategy ? createdStrategy.id : '未找到'}`);

        if (createdStrategy) {
          // Update
          await AppDataManagerV2.coloringStrategies.update(createdStrategy.id, {
            note: 'CRUD测试策略-已更新'
          });
          log(`✅ U-更新: ID ${createdStrategy.id}`);

          // Delete
          await AppDataManagerV2.coloringStrategies.delete(createdStrategy.id);
          log(`✅ D-删除: ID ${createdStrategy.id}`);
        }

        log('✅ CRUD测试完成');
      } catch (error) {
        log(`❌ CRUD测试失败: ${error.message}`);
      }
    }

    // 性能测试
    async function testPerformance() {
      log('⚡ 开始性能测试...');

      const startTime = performance.now();

      try {
        const strategies = await AppDataManagerV2.coloringStrategies.getAll();
        const endTime = performance.now();
        const duration = Math.round(endTime - startTime);

        log(`✅ 性能测试完成: 获取 ${strategies.length} 条记录耗时 ${duration}ms`);
      } catch (error) {
        log(`❌ 性能测试失败: ${error.message}`);
      }
    }

    // 添加测试结果
    function addTestResult(test, success, result) {
      testResults.push({
        test,
        success,
        result,
        timestamp: new Date().toLocaleString()
      });

      updateTestResultsDisplay();
    }

    // 更新测试结果显示
    function updateTestResultsDisplay() {
      const container = document.getElementById('test-results');

      if (testResults.length === 0) {
        container.innerHTML = '<p>暂无测试结果</p>';
        return;
      }

      let html = '';
      testResults.forEach(result => {
        const statusIcon = result.success ? '✅' : '❌';
        const statusClass = result.success ? 'success' : 'error';

        html += `
                    <div class="test-item">
                        <span>${statusIcon} ${result.test}</span>
                        <span class="${statusClass}">${result.timestamp}</span>
                    </div>
                `;
      });

      container.innerHTML = html;
    }

    // 清空结果
    function clearResults() {
      testResults = [];
      updateTestResultsDisplay();
      log('🧹 测试结果已清空');
    }

    // 日志功能
    function log(message) {
      const logOutput = document.getElementById('log-output');
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}\n`;

      logOutput.textContent += logEntry;
      logOutput.scrollTop = logOutput.scrollHeight;

      console.log(message);
    }

    function clearLog() {
      document.getElementById('log-output').textContent = '等待操作...\n';
    }
  </script>
</body>

</html>