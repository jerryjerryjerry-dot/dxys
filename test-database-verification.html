<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®åº“å­˜å‚¨éªŒè¯</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #1890ff;
      text-align: center;
      margin-bottom: 30px;
    }

    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #e8e8e8;
      border-radius: 4px;
    }

    .test-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }

    .result {
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }

    .success {
      background: #f6ffed;
      border: 1px solid #b7eb8f;
      color: #389e0d;
    }

    .error {
      background: #fff2f0;
      border: 1px solid #ffccc7;
      color: #cf1322;
    }

    .info {
      background: #e6f7ff;
      border: 1px solid #91d5ff;
      color: #1890ff;
    }

    button {
      background: #1890ff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }

    button:hover {
      background: #40a9ff;
    }

    pre {
      background: #f8f8f8;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }

    .stat-card {
      background: #fafafa;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }

    .stat-number {
      font-size: 24px;
      font-weight: bold;
      color: #1890ff;
    }

    .stat-label {
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>ğŸ” æ•°æ®åº“å­˜å‚¨éªŒè¯å·¥å…·</h1>

    <div class="test-section">
      <div class="test-title">1. æ•°æ®åº“è¿æ¥çŠ¶æ€</div>
      <div id="db-status" class="result info">æ£€æµ‹ä¸­...</div>
      <button onclick="checkDatabaseConnection()">é‡æ–°æ£€æµ‹</button>
    </div>

    <div class="test-section">
      <div class="test-title">2. æ•°æ®ç»Ÿè®¡</div>
      <div class="stats" id="data-stats">
        <div class="stat-card">
          <div class="stat-number" id="coloring-count">-</div>
          <div class="stat-label">æµé‡æŸ“è‰²ç­–ç•¥</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="recognition-count">-</div>
          <div class="stat-label">è¯†åˆ«ç­–ç•¥</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="apps-count">-</div>
          <div class="stat-label">åº”ç”¨æ€»æ•°</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="watermark-count">-</div>
          <div class="stat-label">æ°´å°é…ç½®</div>
        </div>
      </div>
      <button onclick="loadDataStats()">åˆ·æ–°ç»Ÿè®¡</button>
    </div>

    <div class="test-section">
      <div class="test-title">3. æµé‡æŸ“è‰²ç­–ç•¥è¯¦æƒ…</div>
      <div id="strategies-list"></div>
      <button onclick="loadStrategies()">åŠ è½½ç­–ç•¥</button>
      <button onclick="testAddStrategy()">æµ‹è¯•æ·»åŠ </button>
      <button onclick="clearAllStrategies()">æ¸…ç©ºæ‰€æœ‰ç­–ç•¥</button>
    </div>

    <div class="test-section">
      <div class="test-title">4. æ•°æ®åº“åŸç”Ÿæ“ä½œæµ‹è¯•</div>
      <div id="raw-operations"></div>
      <button onclick="testRawOperations()">æ‰§è¡ŒåŸç”Ÿæ“ä½œ</button>
    </div>

    <div class="test-section">
      <div class="test-title">5. æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ£€æŸ¥</div>
      <div class="result info">
        <strong>æ‰‹åŠ¨éªŒè¯æ­¥éª¤ï¼š</strong><br>
        1. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·<br>
        2. åˆ‡æ¢åˆ° "Application" æ ‡ç­¾<br>
        3. åœ¨å·¦ä¾§æ‰¾åˆ° "Storage" â†’ "IndexedDB"<br>
        4. å±•å¼€ "TrafficSecurityV2DB" æ•°æ®åº“<br>
        5. æŸ¥çœ‹ "coloringStrategies" è¡¨ä¸­çš„æ•°æ®
      </div>
    </div>
  </div>

  <!-- å¼•å…¥ä¾èµ– -->
  <script src="https://unpkg.com/dexie@3.2.4/dist/dexie.js"></script>
  <script src="AppDataManagerV2.js"></script>

  <script>
    let testResults = [];

    // æ£€æŸ¥æ•°æ®åº“è¿æ¥
    async function checkDatabaseConnection() {
      const statusDiv = document.getElementById('db-status');
      try {
        statusDiv.innerHTML = 'ğŸ”„ æ£€æµ‹ä¸­...';

        if (typeof Dexie === 'undefined') {
          throw new Error('Dexie.js æœªåŠ è½½');
        }

        if (!AppDataManagerV2.initialized) {
          await AppDataManagerV2.init();
        }

        if (AppDataManagerV2.db) {
          statusDiv.innerHTML = `
                        <div class="success">
                            âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸<br>
                            æ•°æ®åº“åï¼š${AppDataManagerV2.db.name}<br>
                            ç‰ˆæœ¬ï¼š${AppDataManagerV2.db.verno}<br>
                            çŠ¶æ€ï¼š${AppDataManagerV2.db.isOpen() ? 'å·²æ‰“å¼€' : 'æœªæ‰“å¼€'}
                        </div>
                    `;
        } else {
          throw new Error('æ•°æ®åº“å®ä¾‹ä¸å­˜åœ¨');
        }
      } catch (error) {
        statusDiv.innerHTML = `<div class="error">âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}</div>`;
      }
    }

    // åŠ è½½æ•°æ®ç»Ÿè®¡
    async function loadDataStats() {
      try {
        const coloringCount = await AppDataManagerV2.db.coloringStrategies.count();
        const recognitionCount = await AppDataManagerV2.db.recognitionStrategies.count();
        const internalApps = await AppDataManagerV2.db.internalApps.count();
        const crossBorderApps = await AppDataManagerV2.db.crossBorderApps.count();
        const watermarkCount = await AppDataManagerV2.db.watermarkConfigs.count();

        document.getElementById('coloring-count').textContent = coloringCount;
        document.getElementById('recognition-count').textContent = recognitionCount;
        document.getElementById('apps-count').textContent = internalApps + crossBorderApps;
        document.getElementById('watermark-count').textContent = watermarkCount;
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', error);
      }
    }

    // åŠ è½½æµé‡æŸ“è‰²ç­–ç•¥
    async function loadStrategies() {
      const listDiv = document.getElementById('strategies-list');
      try {
        listDiv.innerHTML = 'ğŸ”„ åŠ è½½ä¸­...';

        const strategies = await AppDataManagerV2.db.coloringStrategies.toArray();

        if (strategies.length === 0) {
          listDiv.innerHTML = '<div class="info">ğŸ“ æš‚æ— ç­–ç•¥æ•°æ®</div>';
          return;
        }

        let html = `<div class="success">âœ… æ‰¾åˆ° ${strategies.length} ä¸ªç­–ç•¥ï¼š</div>`;
        strategies.forEach((strategy, index) => {
          html += `
                        <div style="margin: 10px 0; padding: 10px; background: #f8f8f8; border-radius: 4px;">
                            <strong>${index + 1}. ${strategy.name}</strong><br>
                            <small>ID: ${strategy.id} | èŒƒå›´: ${strategy.scope} | çŠ¶æ€: ${strategy.status ? 'å¯ç”¨' : 'ç¦ç”¨'}</small><br>
                            <small>åˆ›å»ºæ—¶é—´: ${new Date(strategy.createTime).toLocaleString()}</small>
                        </div>
                    `;
        });

        listDiv.innerHTML = html;
      } catch (error) {
        listDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
      }
    }

    // æµ‹è¯•æ·»åŠ ç­–ç•¥
    async function testAddStrategy() {
      try {
        const testStrategy = {
          name: `æµ‹è¯•ç­–ç•¥_${Date.now()}`,
          scope: 'æµ‹è¯•éƒ¨é—¨',
          techniques: ['åº”ç”¨æŸ“è‰²'],
          note: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç­–ç•¥',
          status: true,
          effectObject: 'æµ‹è¯•ç”¨æˆ·',
          coloringConfig: {
            appColoring: {
              enabled: true,
              address: true,
              protocol: false,
              ip: true
            },
            dataFlowColoring: false,
            dataTrackingColoring: false
          },
          createTime: new Date().toISOString()
        };

        const result = await AppDataManagerV2.coloringStrategies.add(testStrategy);
        alert(`âœ… æµ‹è¯•ç­–ç•¥æ·»åŠ æˆåŠŸï¼ID: ${result.id || result}`);
        loadStrategies(); // é‡æ–°åŠ è½½åˆ—è¡¨
        loadDataStats(); // æ›´æ–°ç»Ÿè®¡
      } catch (error) {
        alert(`âŒ æ·»åŠ å¤±è´¥: ${error.message}`);
      }
    }

    // æ¸…ç©ºæ‰€æœ‰ç­–ç•¥
    async function clearAllStrategies() {
      if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æµé‡æŸ“è‰²ç­–ç•¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
        return;
      }

      try {
        await AppDataManagerV2.db.coloringStrategies.clear();
        alert('âœ… æ‰€æœ‰ç­–ç•¥å·²æ¸…ç©º');
        loadStrategies();
        loadDataStats();
      } catch (error) {
        alert(`âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`);
      }
    }

    // æµ‹è¯•åŸç”Ÿæ•°æ®åº“æ“ä½œ
    async function testRawOperations() {
      const resultDiv = document.getElementById('raw-operations');
      let results = [];

      try {
        // 1. ç›´æ¥æŸ¥è¯¢æ•°æ®åº“
        const directQuery = await AppDataManagerV2.db.coloringStrategies.toArray();
        results.push(`âœ… ç›´æ¥æŸ¥è¯¢: æ‰¾åˆ° ${directQuery.length} æ¡è®°å½•`);

        // 2. æµ‹è¯•äº‹åŠ¡
        const transaction = AppDataManagerV2.db.transaction('rw', AppDataManagerV2.db.coloringStrategies, async () => {
          const count = await AppDataManagerV2.db.coloringStrategies.count();
          return count;
        });
        const transactionResult = await transaction;
        results.push(`âœ… äº‹åŠ¡æ“ä½œ: è®°å½•æ•° ${transactionResult}`);

        // 3. æ£€æŸ¥ç´¢å¼•
        const schema = AppDataManagerV2.db.coloringStrategies.schema;
        results.push(`âœ… è¡¨ç»“æ„: ${schema.name}, ä¸»é”®: ${schema.primKey.name}`);

        // 4. å†…å­˜ç¼“å­˜éªŒè¯
        const cacheSize = AppDataManagerV2.cache.coloringStrategies.size;
        results.push(`âœ… å†…å­˜ç¼“å­˜: ${cacheSize} æ¡è®°å½•`);

        resultDiv.innerHTML = `
                    <div class="success">
                        ${results.map(r => `<div>${r}</div>`).join('')}
                    </div>
                `;
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">âŒ åŸç”Ÿæ“ä½œå¤±è´¥: ${error.message}</div>`;
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æµ‹
    window.addEventListener('load', async () => {
      await checkDatabaseConnection();
      await loadDataStats();
      await loadStrategies();
    });
  </script>
</body>

</html>